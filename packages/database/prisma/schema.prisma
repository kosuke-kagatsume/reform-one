generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Organizations
model Organization {
  id                String   @id @default(cuid())
  name              String
  slug              String   @unique
  type              String   @default("CUSTOMER") // REFORM_COMPANY, CUSTOMER
  domainRestriction String   @default("[]") // JSON string for SQLite
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  users         UserOrganization[]
  subscriptions Subscription[]
  settings      OrganizationSettings?
  invitations   Invitation[]
  auditLogs     AuditLog[]
  departments   Department[]
  
  @@index([slug])
  @@index([type])
}

model OrganizationSettings {
  id                String   @id @default(cuid())
  organizationId    String   @unique
  enforceMfa        Boolean  @default(false)
  seatLimit         Int?     // null = unlimited
  allowedDomains    String   @default("[]") // JSON string for SQLite
  customRoles       String?  // JSON string for custom role definitions
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

// Departments (for Reform Company employees)
model Department {
  id             String   @id @default(cuid())
  organizationId String
  name           String   // 企画開発部, 編集部, 管理部
  code           String   // PLANNING, EDITORIAL, MANAGEMENT
  permissions    String   @default("[]") // JSON string for permissions
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  organization Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  users        UserOrganization[]
  
  @@unique([organizationId, code])
  @@index([organizationId])
}

// Users
model User {
  id            String   @id @default(cuid())
  email         String   @unique
  name          String?
  userType      String   @default("CUSTOMER") // EMPLOYEE, CUSTOMER, EXTERNAL_INSTRUCTOR
  password      String?  // null for magic link users
  mfaEnabled    Boolean  @default(false)
  mfaSecret     String?
  emailVerified Boolean  @default(false)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  organizations UserOrganization[]
  sessions      Session[]
  auditLogs     AuditLog[]
  invitations   Invitation[]
  
  @@index([email])
  @@index([userType])
}

model UserOrganization {
  userId         String
  organizationId String
  role           String   @default("MEMBER") // ADMIN, MEMBER, DEPARTMENT_MANAGER
  departmentId   String?
  joinedAt       DateTime @default(now())
  
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  department   Department?  @relation(fields: [departmentId], references: [id], onDelete: SetNull)
  
  @@id([userId, organizationId])
  @@index([organizationId])
  @@index([userId])
  @@index([departmentId])
}

// Sessions
model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([sessionToken])
  @@index([userId])
}

// Invitations
model Invitation {
  id             String   @id @default(cuid())
  email          String
  token          String   @unique
  organizationId String
  role           String   @default("MEMBER") // ADMIN, MEMBER, DEPARTMENT_MANAGER
  invitedById    String
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime @default(now())
  
  organization Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  invitedBy    User         @relation(fields: [invitedById], references: [id])
  
  @@index([token])
  @@index([email, organizationId])
}

// Billing & Subscriptions
model Subscription {
  id                 String   @id @default(cuid())
  organizationId     String
  planType           String   // STANDARD, EXPERT
  status             String   @default("PENDING") // ACTIVE, SUSPENDED, CANCELLED, PENDING
  paymentMethod      String   @default("CARD") // CARD, BANK_TRANSFER, CONVENIENCE_STORE
  basePrice          Float    // 基本価格
  discountPercent    Float    @default(0) // 割引率 (0-100)
  discountAmount     Float    @default(0) // 割引額
  finalPrice         Float    // 最終価格
  userLimit          Int?     // null = unlimited
  autoRenewal        Boolean  @default(true)
  stripeCustomerId   String?
  stripeSubscriptionId String? @unique
  currentPeriodStart DateTime
  currentPeriodEnd   DateTime
  renewalNotifiedAt  DateTime?
  cancelAt           DateTime?
  canceledAt         DateTime?
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt

  organization Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  entitlements Entitlement[]
  addons       Addon[]
  invoices     Invoice[]

  @@index([organizationId])
  @@index([stripeSubscriptionId])
  @@index([status])
  @@index([currentPeriodEnd])
}

model Entitlement {
  id             String   @id @default(cuid())
  subscriptionId String
  feature        String   // e-paper, community, databook, newsletter, etc
  limit          Int?     // null = unlimited
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  @@unique([subscriptionId, feature])
  @@index([subscriptionId])
}

model Addon {
  id             String   @id @default(cuid())
  subscriptionId String
  type           String   // paper, electronic_id
  quantity       Int      @default(1)
  pricePerUnit   Float
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt
  
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  @@index([subscriptionId])
}

model Invoice {
  id               String   @id @default(cuid())
  subscriptionId   String
  stripeInvoiceId  String   @unique
  amount           Float
  currency         String   @default("JPY")
  status           String   // draft, open, paid, void, uncollectible
  paidAt           DateTime?
  dueDate          DateTime?
  invoiceNumber    String   @unique
  invoicePdf       String?
  taxAmount        Float?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  subscription Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)
  
  @@index([subscriptionId])
  @@index([stripeInvoiceId])
}

// Audit Logs
model AuditLog {
  id           String   @id @default(cuid())
  userId       String?
  orgId        String?
  action       String   // user.login, billing.upgrade, article.publish, etc
  resource     String?  // article:123, subscription:456
  metadata     String?  // JSON string for SQLite
  ip           String?
  userAgent    String?
  timestamp    DateTime @default(now())

  user         User?         @relation(fields: [userId], references: [id], onDelete: SetNull)
  organization Organization? @relation(fields: [orgId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([orgId])
  @@index([action])
  @@index([timestamp])
}

// ============================================
// Premier Subscription System Models
// ============================================

// Seminar Categories
model SeminarCategory {
  id          String   @id @default(cuid())
  name        String   // 営業セミナー, 業界標準化研修, スペシャリストセミナー, オンライン物件紹介
  slug        String   @unique
  description String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  seminars Seminar[]
  archives Archive[]

  @@index([slug])
}

// Seminars
model Seminar {
  id           String   @id @default(cuid())
  categoryId   String
  title        String
  description  String?
  instructor   String?
  imageUrl     String?
  zoomUrl      String?
  scheduledAt  DateTime
  duration     Int?     // minutes
  isPublic     Boolean  @default(false) // for open seminars
  publicPrice  Float?   // price for external participants
  notificationSentAt DateTime? // when notification email was sent
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  category     SeminarCategory    @relation(fields: [categoryId], references: [id])
  participants SeminarParticipant[]

  @@index([categoryId])
  @@index([scheduledAt])
  @@index([isPublic])
}

// Seminar Participants (for tracking)
model SeminarParticipant {
  id         String   @id @default(cuid())
  seminarId  String
  userId     String
  registeredAt DateTime @default(now())
  attendedAt DateTime?

  seminar Seminar @relation(fields: [seminarId], references: [id], onDelete: Cascade)

  @@unique([seminarId, userId])
  @@index([seminarId])
  @@index([userId])
}

// Archives (YouTube videos)
model Archive {
  id          String   @id @default(cuid())
  categoryId  String
  title       String
  description String?
  youtubeUrl  String
  thumbnailUrl String?
  duration    Int?     // minutes
  publishedAt DateTime @default(now())
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category SeminarCategory @relation(fields: [categoryId], references: [id])
  views    ArchiveView[]

  @@index([categoryId])
  @@index([publishedAt])
}

// Archive Views (for tracking)
model ArchiveView {
  id        String   @id @default(cuid())
  archiveId String
  userId    String
  viewedAt  DateTime @default(now())

  archive Archive @relation(fields: [archiveId], references: [id], onDelete: Cascade)

  @@index([archiveId])
  @@index([userId])
  @@index([viewedAt])
}

// Community Categories
model CommunityCategory {
  id                String   @id @default(cuid())
  name              String   // 人事, 施工管理, 設計, 広報
  slug              String   @unique
  description       String?
  meetingUrl        String?  // fixed Zoom registration URL
  sortOrder         Int      @default(0)
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  posts             CommunityPost[]
  meetingArchives   MeetingArchive[]

  @@index([slug])
}

// Community Posts
model CommunityPost {
  id          String   @id @default(cuid())
  categoryId  String
  authorId    String
  title       String
  content     String
  attachments String   @default("[]") // JSON array of attachment URLs
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category CommunityCategory @relation(fields: [categoryId], references: [id])

  @@index([categoryId])
  @@index([authorId])
  @@index([createdAt])
}

// Meeting Archives
model MeetingArchive {
  id          String   @id @default(cuid())
  categoryId  String
  title       String
  description String?
  youtubeUrl  String
  heldAt      DateTime
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  category CommunityCategory @relation(fields: [categoryId], references: [id])

  @@index([categoryId])
  @@index([heldAt])
}

// Activity Log (for tracking user activities)
model ActivityLog {
  id           String   @id @default(cuid())
  userId       String
  orgId        String?
  activityType String   // seminar_register, seminar_attend, archive_view, community_view, community_post
  resourceType String?  // seminar, archive, community
  resourceId   String?
  metadata     String?  // JSON string
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([orgId])
  @@index([activityType])
  @@index([createdAt])
}

// ============================================
// Phase 2: Databook & Newsletter Models
// ============================================

// Databook (Expert plan only - quarterly PDFs with YouTube explanations)
model Databook {
  id           String   @id @default(cuid())
  title        String   // e.g., "2025年Q1 業界動向レポート"
  description  String?
  pdfUrl       String   // URL to the PDF file
  youtubeUrl   String?  // Optional: explanation video URL
  quarter      String   // e.g., "2025-Q1", "2025-Q2"
  publishedAt  DateTime @default(now())
  isPublished  Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  downloads DatabookDownload[]

  @@index([quarter])
  @@index([publishedAt])
  @@index([isPublished])
}

// Databook Download tracking
model DatabookDownload {
  id         String   @id @default(cuid())
  databookId String
  userId     String
  downloadedAt DateTime @default(now())

  databook Databook @relation(fields: [databookId], references: [id], onDelete: Cascade)

  @@index([databookId])
  @@index([userId])
  @@index([downloadedAt])
}

// Newsletter (Expert plan only)
model Newsletter {
  id          String   @id @default(cuid())
  title       String
  content     String   // HTML content
  summary     String?  // Plain text summary for email
  authorId    String   // Author (Reform Company employee)
  sentAt      DateTime?
  isPublished Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([sentAt])
  @@index([isPublished])
  @@index([authorId])
}