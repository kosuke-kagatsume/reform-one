generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Organization {
  id                   String                  @id @default(cuid())
  name                 String
  slug                 String                  @unique
  type                 String                  @default("CUSTOMER")
  domainRestriction    String                  @default("[]")
  // 組織追加情報
  logoUrl              String?
  email                String?
  phone                String?
  address              String?
  website              String?
  industry             String?
  description          String?
  existingSubscriptionTypes String              @default("[]")
  adminNotes           String?
  createdAt            DateTime                @default(now())
  updatedAt            DateTime                @updatedAt
  auditLogs            AuditLog[]
  departments          Department[]
  invitations          Invitation[]
  settings             OrganizationSettings?
  subscriptions        Subscription[]
  users                UserOrganization[]
  reminderSetting      ReminderSetting?
  changeLogs           OrganizationChangeLog[]
  payments             Payment[]
  digitalNewspaperAccess DigitalNewspaperAccess?

  @@index([slug])
  @@index([type])
}

model OrganizationSettings {
  id             String       @id @default(cuid())
  organizationId String       @unique
  enforceMfa     Boolean      @default(false)
  seatLimit      Int?
  allowedDomains String       @default("[]")
  customRoles    String?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
}

model Department {
  id             String             @id @default(cuid())
  organizationId String
  name           String
  code           String
  permissions    String             @default("[]")
  createdAt      DateTime           @default(now())
  updatedAt      DateTime           @updatedAt
  organization   Organization       @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  users          UserOrganization[]

  @@unique([organizationId, code])
  @@index([organizationId])
}

model User {
  id              String             @id @default(cuid())
  email           String             @unique
  name            String?
  userType        String             @default("CUSTOMER")
  password        String?
  mfaEnabled      Boolean            @default(false)
  mfaSecret       String?
  emailVerified   Boolean            @default(false)
  lastLoginAt     DateTime?
  lastActivityAt  DateTime?          // 最終アクティビティ日時（セミナー参加、アーカイブ視聴等）
  adminPermissionLevel String?
  status          String             @default("ACTIVE")
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  auditLogs       AuditLog[]
  invitations     Invitation[]
  sessions        Session[]
  organizations   UserOrganization[]
  sentEmails      EmailHistory[]     @relation("SentEmails")
  notifications   Notification[]
  notificationPref NotificationPreference?
  payments        Payment[]

  @@index([email])
  @@index([userType])
  @@index([lastLoginAt])
  @@index([lastActivityAt])
  @@index([status])
}

model UserOrganization {
  userId         String
  organizationId String
  role           String       @default("MEMBER")
  departmentId   String?
  joinedAt       DateTime     @default(now())
  department     Department?  @relation(fields: [departmentId], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  user           User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, organizationId])
  @@index([organizationId])
  @@index([userId])
  @@index([departmentId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([sessionToken])
  @@index([userId])
}

model Invitation {
  id             String       @id @default(cuid())
  email          String
  token          String       @unique
  organizationId String
  role           String       @default("MEMBER")
  invitedById    String
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime     @default(now())
  invitedBy      User         @relation(fields: [invitedById], references: [id])
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([email, organizationId])
}

model Subscription {
  id                   String        @id @default(cuid())
  organizationId       String
  planType             String
  status               String        @default("PENDING")
  paymentMethod        String        @default("CARD")
  basePrice            Float
  discountType         String        @default("NONE")
  discountPercent      Float         @default(0)
  discountAmount       Float         @default(0)
  finalPrice           Float
  userLimit            Int?
  autoRenewal          Boolean       @default(true)
  stripeCustomerId     String?
  stripeSubscriptionId String?       @unique
  currentPeriodStart   DateTime
  currentPeriodEnd     DateTime
  renewalNotifiedAt    DateTime?
  cancelAt             DateTime?
  canceledAt           DateTime?
  scheduledPlanChange  String?       // 次回更新時に変更するプラン（STANDARD/EXPERT）
  createdAt            DateTime      @default(now())
  updatedAt            DateTime      @updatedAt
  addons               Addon[]
  entitlements         Entitlement[]
  invoices             Invoice[]
  organization         Organization  @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([stripeSubscriptionId])
  @@index([status])
  @@index([currentPeriodEnd])
}

model Entitlement {
  id             String       @id @default(cuid())
  subscriptionId String
  feature        String
  limit          Int?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@unique([subscriptionId, feature])
  @@index([subscriptionId])
}

model Addon {
  id             String       @id @default(cuid())
  subscriptionId String
  type           String
  quantity       Int          @default(1)
  pricePerUnit   Float
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  subscription   Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
}

model Invoice {
  id              String       @id @default(cuid())
  subscriptionId  String
  stripeInvoiceId String       @unique
  amount          Float
  currency        String       @default("JPY")
  status          String
  paidAt          DateTime?
  dueDate         DateTime?
  invoiceNumber   String       @unique
  invoicePdf      String?
  taxAmount       Float?
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  subscription    Subscription @relation(fields: [subscriptionId], references: [id], onDelete: Cascade)

  @@index([subscriptionId])
  @@index([stripeInvoiceId])
}

model AuditLog {
  id           String        @id @default(cuid())
  userId       String?
  orgId        String?
  action       String
  resource     String?
  metadata     String?
  ip           String?
  userAgent    String?
  timestamp    DateTime      @default(now())
  organization Organization? @relation(fields: [orgId], references: [id])
  user         User?         @relation(fields: [userId], references: [id])

  @@index([userId])
  @@index([orgId])
  @@index([action])
  @@index([timestamp])
}

model SeminarCategory {
  id          String        @id @default(cuid())
  name        String
  slug        String        @unique
  description String?
  roleId      String?
  sortOrder   Int           @default(0)
  isVisible   Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  role        CategoryRole? @relation(fields: [roleId], references: [id])
  archives    Archive[]
  seminars    Seminar[]

  @@index([slug])
  @@index([isVisible])
  @@index([roleId])
}

// カテゴリ役割マスタ（集客用/研修用/アーカイブ専用等）
model CategoryRole {
  id          String            @id @default(cuid())
  name        String            @unique
  description String?
  color       String?
  sortOrder   Int               @default(0)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  categories  SeminarCategory[]

  @@index([sortOrder])
}

model Seminar {
  id                 String               @id @default(cuid())
  categoryId         String
  title              String
  description        String?
  instructor         String?
  imageUrl           String?
  zoomUrl            String?
  scheduledAt        DateTime
  duration           Int?
  isPublic           Boolean              @default(false)
  publicPrice        Float?
  notificationSentAt DateTime?
  createdAt          DateTime             @default(now())
  updatedAt          DateTime             @updatedAt
  category           SeminarCategory      @relation(fields: [categoryId], references: [id])
  participants       SeminarParticipant[]

  @@index([categoryId])
  @@index([scheduledAt])
  @@index([isPublic])
}

model SeminarParticipant {
  id           String    @id @default(cuid())
  seminarId    String
  userId       String
  registeredAt DateTime  @default(now())
  attendedAt   DateTime?
  seminar      Seminar   @relation(fields: [seminarId], references: [id], onDelete: Cascade)

  @@unique([seminarId, userId])
  @@index([seminarId])
  @@index([userId])
}

model Archive {
  id                   String          @id @default(cuid())
  categoryId           String
  title                String
  description          String?
  youtubeUrl           String
  thumbnailUrl         String?
  duration             Int?
  // ショートバージョン（10分版）
  shortVersionUrl      String?
  shortVersionDuration Int?
  // Phase 2追加: 対象者・おすすめ情報
  targetAudience       String?         // 対象者（例：経営者向け、営業責任者向け）
  recommendReason      String?         // おすすめ理由（1行）
  learningOutcome      String?         // 得られること
  viewCount            Int             @default(0) // 視聴回数（キャッシュ用）
  publishedAt          DateTime        @default(now())
  createdAt            DateTime        @default(now())
  updatedAt            DateTime        @updatedAt
  category             SeminarCategory @relation(fields: [categoryId], references: [id])
  views                ArchiveView[]

  @@index([categoryId])
  @@index([publishedAt])
  @@index([viewCount])
}

model ArchiveView {
  id        String   @id @default(cuid())
  archiveId String
  userId    String
  viewedAt  DateTime @default(now())
  archive   Archive  @relation(fields: [archiveId], references: [id], onDelete: Cascade)

  @@index([archiveId])
  @@index([userId])
  @@index([viewedAt])
}

model CommunityCategory {
  id              String             @id @default(cuid())
  name            String
  slug            String             @unique
  description     String?
  meetingUrl      String?            // 常設ZoomリンクURL
  frequency       String?            // 開催頻度（例：月1回）
  nextMeetingAt   DateTime?          // 次回開催日時
  sortOrder       Int                @default(0)
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  posts           CommunityPost[]
  meetingArchives MeetingArchive[]
  meetings        CommunityMeeting[]

  @@index([slug])
  @@index([nextMeetingAt])
}

model CommunityPost {
  id          String            @id @default(cuid())
  categoryId  String
  authorId    String
  title       String
  content     String
  attachments String            @default("[]")
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  category    CommunityCategory @relation(fields: [categoryId], references: [id])

  @@index([categoryId])
  @@index([authorId])
  @@index([createdAt])
}

model MeetingArchive {
  id          String            @id @default(cuid())
  categoryId  String
  title       String
  description String?
  youtubeUrl  String
  heldAt      DateTime
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  category    CommunityCategory @relation(fields: [categoryId], references: [id])

  @@index([categoryId])
  @@index([heldAt])
}

model ActivityLog {
  id           String   @id @default(cuid())
  userId       String
  orgId        String?
  activityType String
  resourceType String?
  resourceId   String?
  metadata     String?
  createdAt    DateTime @default(now())

  @@index([userId])
  @@index([orgId])
  @@index([activityType])
  @@index([createdAt])
}

model Databook {
  id            String             @id @default(cuid())
  title         String
  description   String?
  coverImageUrl String?            // 表紙画像URL
  pdfUrl        String
  youtubeUrl    String?
  quarter       String
  year          Int?               // 発行年
  publishedAt   DateTime           @default(now())
  isPublished   Boolean            @default(false)
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt
  downloads     DatabookDownload[]

  @@index([quarter])
  @@index([year])
  @@index([publishedAt])
  @@index([isPublished])
}

model DatabookDownload {
  id           String   @id @default(cuid())
  databookId   String
  userId       String
  downloadedAt DateTime @default(now())
  databook     Databook @relation(fields: [databookId], references: [id], onDelete: Cascade)

  @@index([databookId])
  @@index([userId])
  @@index([downloadedAt])
}

model Newsletter {
  id          String    @id @default(cuid())
  title       String
  content     String
  summary     String?
  pdfUrl      String?   // PDFファイルURL
  issueDate   String?   // 発行年月（例：2026年1月号）
  authorId    String
  sentAt      DateTime?
  isPublished Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@index([sentAt])
  @@index([isPublished])
  @@index([authorId])
}

model SiteVisit {
  id                    String                 @id @default(cuid())
  title                 String
  description           String?
  companyName           String?                // 視察先企業名
  location              String                 // 都道府県＋市
  address               String?
  imageUrl              String?
  scheduledAt           DateTime
  duration              Int?
  capacity              Int                    @default(20)
  maxPerOrganization    Int                    @default(2) // 1社あたり最大人数
  // プラン別価格
  priceStandard         Float                  // スタンダード価格（例：20000）
  priceExpert           Float                  @default(0) // エキスパート価格（通常0=無料）
  expertFreeQuota       Int                    @default(2) // エキスパート無料枠（人数）
  // 懇親会
  hasAfterParty         Boolean                @default(false)
  afterPartyPrice       Float?                 // 懇親会価格（例：5000-6000）
  afterPartyCapacity    Int?
  afterPartyLocation    String?
  // ステータス
  isPublished           Boolean                @default(false)
  isCanceled            Boolean                @default(false)
  createdAt             DateTime               @default(now())
  updatedAt             DateTime               @updatedAt
  participants          SiteVisitParticipant[]

  @@index([scheduledAt])
  @@index([isPublished])
}

model SiteVisitParticipant {
  id                    String    @id @default(cuid())
  siteVisitId           String
  userId                String
  organizationId        String?
  // 参加情報
  numberOfPeople        Int       @default(1) // 参加人数（1-2人）
  status                String    @default("PENDING") // PENDING, CONFIRMED, CANCELED
  // 支払い
  paymentStatus         String    @default("UNPAID") // UNPAID, PAID, REFUNDED
  paymentMethod         String?   // STRIPE, ONSITE（当日支払い）
  amount                Float?    // 支払い金額
  stripePaymentIntentId String?
  // 懇親会
  joinAfterParty        Boolean   @default(false)
  afterPartyPeople      Int       @default(0) // 懇親会参加人数
  afterPartyPaymentStatus String? // UNPAID, PAID
  // タイムスタンプ
  registeredAt          DateTime  @default(now())
  paidAt                DateTime?
  attendedAt            DateTime?
  siteVisit             SiteVisit @relation(fields: [siteVisitId], references: [id], onDelete: Cascade)

  @@unique([siteVisitId, userId])
  @@index([siteVisitId])
  @@index([userId])
  @@index([organizationId])
  @@index([status])
  @@index([paymentStatus])
}

// オンライン現場見学会（Zoom配信）
model OnlineSiteVisit {
  id                 String                      @id @default(cuid())
  title              String
  description        String?
  companyName        String?                     // 視察先企業名
  location           String?                     // 都道府県（参考情報）
  imageUrl           String?
  zoomUrl            String?                     // Zoom配信URL
  scheduledAt        DateTime
  duration           Int?                        // 分
  capacity           Int                         @default(100)
  // プラン別
  requiredPlan       String                      @default("STANDARD") // STANDARD or EXPERT
  // ステータス
  isPublished        Boolean                     @default(false)
  isCanceled         Boolean                     @default(false)
  notificationSentAt DateTime?                   // 通知送信日時
  createdAt          DateTime                    @default(now())
  updatedAt          DateTime                    @updatedAt
  participants       OnlineSiteVisitParticipant[]

  @@index([scheduledAt])
  @@index([isPublished])
  @@index([requiredPlan])
}

model OnlineSiteVisitParticipant {
  id                String          @id @default(cuid())
  onlineSiteVisitId String
  userId            String
  organizationId    String?
  status            String          @default("REGISTERED") // REGISTERED, ATTENDED, CANCELED
  registeredAt      DateTime        @default(now())
  attendedAt        DateTime?
  onlineSiteVisit   OnlineSiteVisit @relation(fields: [onlineSiteVisitId], references: [id], onDelete: Cascade)

  @@unique([onlineSiteVisitId, userId])
  @@index([onlineSiteVisitId])
  @@index([userId])
  @@index([organizationId])
  @@index([status])
}

model Qualification {
  id          String              @id @default(cuid())
  name        String
  code        String              @unique
  description String?
  isActive    Boolean             @default(true)
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  courses     UserQualification[]

  @@index([code])
  @@index([isActive])
}

model UserQualification {
  id              String        @id @default(cuid())
  userId          String
  qualificationId String
  organizationId  String?
  status          String        @default("ENROLLED")
  enrolledAt      DateTime      @default(now())
  completedAt     DateTime?
  expiresAt       DateTime?
  certificateUrl  String?
  qualification   Qualification @relation(fields: [qualificationId], references: [id], onDelete: Cascade)

  @@unique([userId, qualificationId])
  @@index([userId])
  @@index([qualificationId])
  @@index([organizationId])
  @@index([status])
}

model Tool {
  id           String         @id @default(cuid())
  name         String
  slug         String         @unique
  description  String?
  category     String
  purposeId    String?
  fileUrl      String?
  fileFormat   String?        // Excel, Word, PDF等
  externalUrl  String?
  iconName     String?
  requiredPlan String         @default("STANDARD")
  status       String         @default("AVAILABLE") // AVAILABLE, PREPARING, COMING_SOON
  sortOrder    Int            @default(0)
  isPublished  Boolean        @default(true)
  createdAt    DateTime       @default(now())
  updatedAt    DateTime       @updatedAt
  purpose      ToolPurpose?   @relation(fields: [purposeId], references: [id])
  usageLogs    ToolUsageLog[]

  @@index([slug])
  @@index([category])
  @@index([purposeId])
  @@index([requiredPlan])
  @@index([status])
  @@index([isPublished])
}

// ツール用途マスタ（現調用/見積用/契約用/安全管理/顧客満足等）
model ToolPurpose {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  color       String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  tools       Tool[]

  @@index([sortOrder])
}

model ToolUsageLog {
  id        String   @id @default(cuid())
  toolId    String
  userId    String
  action    String
  createdAt DateTime @default(now())
  tool      Tool     @relation(fields: [toolId], references: [id], onDelete: Cascade)

  @@index([toolId])
  @@index([userId])
  @@index([createdAt])
}

model Recommendation {
  id          String                    @id @default(cuid())
  title       String
  description String?
  imageUrl    String?
  linkUrl     String
  linkText    String                    @default("詳細を見る")
  targetType  String
  position    String                    @default("POPUP")
  priority    Int                       @default(0)
  startAt     DateTime?
  endAt       DateTime?
  isActive    Boolean                   @default(true)
  createdAt   DateTime                  @default(now())
  updatedAt   DateTime                  @updatedAt
  dismissals  RecommendationDismissal[]

  @@index([targetType])
  @@index([position])
  @@index([isActive])
  @@index([startAt])
  @@index([endAt])
}

model RecommendationDismissal {
  id               String         @id @default(cuid())
  recommendationId String
  userId           String
  dismissedAt      DateTime       @default(now())
  recommendation   Recommendation @relation(fields: [recommendationId], references: [id], onDelete: Cascade)

  @@unique([recommendationId, userId])
  @@index([recommendationId])
  @@index([userId])
}

model OpenSeminarRegistration {
  id                    String    @id @default(cuid())
  seminarId             String
  name                  String
  email                 String
  company               String?
  phone                 String?
  paymentStatus         String    @default("UNPAID")
  stripePaymentIntentId String?
  registeredAt          DateTime  @default(now())
  paidAt                DateTime?

  @@index([seminarId])
  @@index([email])
  @@index([paymentStatus])
}

model PasswordResetToken {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([token])
  @@index([userId])
  @@index([expiresAt])
}

model EmailVerificationToken {
  id        String    @id @default(cuid())
  userId    String
  token     String    @unique
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([token])
  @@index([userId])
}

model MfaBackupCode {
  id        String    @id @default(cuid())
  userId    String
  code      String
  usedAt    DateTime?
  createdAt DateTime  @default(now())

  @@index([userId])
}

// メールテンプレート（管理画面で編集可能）
model EmailTemplate {
  id          String   @id @default(cuid())
  code        String   @unique  // FOLLOW_UP, USAGE_PROMOTION, RENEWAL_NOTICE等
  name        String
  description String?
  subject     String
  bodyHtml    String
  bodyText    String?
  variables   String   @default("[]")  // 利用可能な変数リスト（JSON）
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([code])
  @@index([isActive])
}

// メール送信履歴
model EmailHistory {
  id             String        @id @default(cuid())
  templateType   String        // CONTACT, RENEWAL_NOTICE, SEMINAR_NOTIFICATION, etc.
  recipientEmail String
  recipientName  String?
  recipientType  String        // ORGANIZATION, USER
  recipientId    String?       // Organization ID or User ID
  subject        String
  body           String?
  status         String        @default("SENT") // SENT, FAILED, PENDING
  sentById       String
  sentAt         DateTime      @default(now())
  metadata       String?       // JSON string for additional data
  sentBy         User          @relation("SentEmails", fields: [sentById], references: [id])

  @@index([recipientEmail])
  @@index([recipientType, recipientId])
  @@index([templateType])
  @@index([sentById])
  @@index([sentAt])
}

// =====================================================
// Phase 2: 通知・リマインド・管理機能
// =====================================================

// 通知（アプリ内通知）
model Notification {
  id        String    @id @default(cuid())
  userId    String
  type      String    // SEMINAR, ARCHIVE, DATABOOK, NEWSLETTER, COMMUNITY, SITE_VISIT, SYSTEM
  title     String
  body      String?
  link      String?   // クリック時の遷移先
  isRead    Boolean   @default(false)
  readAt    DateTime?
  createdAt DateTime  @default(now())
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([type])
  @@index([isRead])
  @@index([createdAt])
}

// 通知設定（ユーザーごと）
model NotificationPreference {
  id                    String   @id @default(cuid())
  userId                String   @unique
  // セミナー関連
  seminarEmail          Boolean  @default(true)
  seminarInApp          Boolean  @default(true)
  // アーカイブ関連
  archiveEmail          Boolean  @default(true)
  archiveInApp          Boolean  @default(true)
  // データブック関連
  databookEmail         Boolean  @default(true)
  databookInApp         Boolean  @default(true)
  // ニュースレター関連
  newsletterEmail       Boolean  @default(true)
  newsletterInApp       Boolean  @default(true)
  // コミュニティ関連
  communityEmail        Boolean  @default(true)
  communityInApp        Boolean  @default(true)
  // 視察会関連
  siteVisitEmail        Boolean  @default(true)
  siteVisitInApp        Boolean  @default(true)
  // システム通知（重要なお知らせ）
  systemEmail           Boolean  @default(true)
  systemInApp           Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  user                  User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// リマインド設定（組織ごと）
model ReminderSetting {
  id                  String       @id @default(cuid())
  organizationId      String       @unique
  isEnabled           Boolean      @default(true)
  daysThreshold       Int          @default(14)  // 何日未ログインでリマインド
  targetType          String       @default("ALL") // ALL, SELECTED
  selectedUserIds     String       @default("[]") // JSON array of user IDs
  customSubject       String?
  customBody          String?
  createdAt           DateTime     @default(now())
  updatedAt           DateTime     @updatedAt
  organization        Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)
  logs                ReminderLog[]

  @@index([organizationId])
  @@index([isEnabled])
}

// リマインド送信履歴
model ReminderLog {
  id                String          @id @default(cuid())
  reminderSettingId String
  userId            String
  email             String
  status            String          @default("SENT") // SENT, FAILED
  sentAt            DateTime        @default(now())
  reminderSetting   ReminderSetting @relation(fields: [reminderSettingId], references: [id], onDelete: Cascade)

  @@index([reminderSettingId])
  @@index([userId])
  @@index([sentAt])
}

// 組織変更履歴
model OrganizationChangeLog {
  id             String       @id @default(cuid())
  organizationId String
  changedById    String
  changeType     String       // NAME, EMAIL, ADDRESS, DOMAIN_ADD, DOMAIN_REMOVE, LOGO, SETTINGS
  fieldName      String?
  oldValue       String?
  newValue       String?
  createdAt      DateTime     @default(now())
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([changedById])
  @@index([changeType])
  @@index([createdAt])
}

// コミュニティ定例会
model CommunityMeeting {
  id          String            @id @default(cuid())
  categoryId  String
  title       String
  description String?
  zoomUrl     String?
  scheduledAt DateTime
  duration    Int?              // 分
  isPublished Boolean           @default(false)
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  category    CommunityCategory @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@index([categoryId])
  @@index([scheduledAt])
  @@index([isPublished])
}

// 資格無料枠管理（組織・契約期間ごと）
model QualificationFreeQuota {
  id               String   @id @default(cuid())
  organizationId   String
  qualificationId  String
  periodStart      DateTime // 契約開始日
  periodEnd        DateTime // 契約終了日
  totalQuota       Int      @default(1) // 無料枠数（通常1）
  usedQuota        Int      @default(0) // 使用済み枠数
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  @@unique([organizationId, qualificationId, periodStart])
  @@index([organizationId])
  @@index([qualificationId])
  @@index([periodEnd])
}

model SystemSetting {
  id        String   @id @default(cuid())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt
  updatedBy String?

  @@index([key])
}

// 電子版リフォーム産業新聞
model DigitalNewspaperEdition {
  id           String   @id @default(cuid())
  title        String                          // 号数・タイトル（例: 2026年2月15日号）
  issueDate    DateTime                        // 発行日
  pdfUrl       String                          // PDFファイルURL
  thumbnailUrl String?                         // サムネイル画像URL
  pageCount    Int?                            // ページ数
  description  String?                         // 概要
  isPublished  Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  @@index([issueDate])
  @@index([isPublished])
}

// 電子版アクセス権限（1組織につき1名のみ）
model DigitalNewspaperAccess {
  id             String       @id @default(cuid())
  organizationId String       @unique            // 1組織につき1レコード
  userId         String                          // アクセス権を持つユーザー
  grantedAt      DateTime     @default(now())
  grantedBy      String?                         // 付与した管理者
  organization   Organization @relation(fields: [organizationId], references: [id], onDelete: Cascade)

  @@index([userId])
}

// C-5: 決済履歴モデル
model Payment {
  id                    String       @id @default(cuid())
  organizationId        String?
  userId                String
  type                  String       // SITE_VISIT, QUALIFICATION, AFTER_PARTY, SUBSCRIPTION
  amount                Int          // 金額（円）
  status                String       @default("PENDING") // PENDING, COMPLETED, FAILED, REFUNDED
  stripeSessionId       String?      // Stripe Checkout Session ID
  stripePaymentIntentId String?      // Stripe Payment Intent ID
  description           String?
  metadata              String?      // JSON形式の追加情報
  paidAt                DateTime?
  refundedAt            DateTime?
  createdAt             DateTime     @default(now())
  updatedAt             DateTime     @updatedAt
  organization          Organization? @relation(fields: [organizationId], references: [id], onDelete: SetNull)
  user                  User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([organizationId])
  @@index([userId])
  @@index([stripeSessionId])
  @@index([stripePaymentIntentId])
  @@index([status])
  @@index([createdAt])
}
